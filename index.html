/* 3D Editing transform */
.edit-3d {
  transform: perspective(700px) rotateX(25deg) rotateY(10deg);
  transform-origin: center;
  transition: transform .3s, fill .3s, rx .3s, ry .3s;
}

/* Make draggable objects look interactive */
.draggable {
  cursor: grab;
}
.draggable:active {
  cursor: grabbing;
}
<div id="toolbar" class="toolbar">
  <button id="regen" class="btn">ğŸ” Regenerate</button>
  <button id="export" class="btn primary">â¬‡ï¸ Export SVG</button>
</div>
<div id="toolbar" class="toolbar">
  <button id="regen" class="btn">ğŸ” Regenerate</button>
  <button id="undo" class="btn">â†©ï¸ Undo</button>
  <button id="redo" class="btn">â†ªï¸ Redo</button>
  <button id="export" class="btn primary">â¬‡ï¸ Export SVG</button>
</div>
<!-- UNIVERSAL 3D EDITOR -->
<div id="editor3d" class="panel" style="display:none; width:260px;">
  <h3>Edit Object (3D)</h3>

  <label>Width</label>
  <input type="range" id="itemWidth" min="20" max="400" value="120">

  <label>Height</label>
  <input type="range" id="itemHeight" min="20" max="300" value="90">

  <label>Rotation</label>
  <input type="range" id="itemRotate" min="-45" max="45" value="0">

  <label>Color</label>
  <input type="color" id="itemColor" value="#67e8f9">

  <label>Shape</label>
  <select id="itemShape">
    <option value="ellipse">Ellipse</option>
    <option value="rect">Rectangle</option>
    <option value="rounded">Rounded Rectangle</option>
  </select>

  <button class="btn" id="close3D">Close</button>
</div>
/* ============================
      UNDO / REDO SYSTEM
============================ */
let historyStack = [];
let redoStack = [];

function saveState() {
  historyStack.push(svg.innerHTML);
  if (historyStack.length > 50) historyStack.shift(); // safety cap
  redoStack = [];
}

function undo() {
  if (historyStack.length === 0) return;

  redoStack.push(svg.innerHTML);
  svg.innerHTML = historyStack.pop();
  rebindInteractive();
}

function redo() {
  if (redoStack.length === 0) return;

  historyStack.push(svg.innerHTML);
  svg.innerHTML = redoStack.pop();
  rebindInteractive();
}

document.getElementById("undo").onclick = undo;
document.getElementById("redo").onclick = redo;

/* Rebind draggables + editables when SVG reloads */
function rebindInteractive() {
  svg.querySelectorAll(".main-object").forEach(el => {
   /* ============================
        DRAG TO MOVE
============================ */
let dragItem = null;
let dragOffset = { x: 0, y: 0 };

function enableDrag(el) {
  el.classList.add("draggable");

  el.addEventListener("mousedown", startDrag);
}

function startDrag(e) {
  if (activeItem) return; // editing takes priority

  dragItem = e.target;
  saveState();

  const CTM = svg.getScreenCTM();
  const mx = (e.clientX - CTM.e) / CTM.a;
  const my = (e.clientY - CTM.f) / CTM.d;

  if (dragItem.tagName === "rect") {
    dragOffset.x = mx - parseFloat(dragItem.getAttribute("x"));
    dragOffset.y = my - parseFloat(dragItem.getAttribute("y"));
  } 
  else {
    // ellipse / circle
    dragOffset.x = mx - parseFloat(dragItem.getAttribute("cx"));
    dragOffset.y = my - parseFloat(dragItem.getAttribute("cy"));
  }

  svg.addEventListener("mousemove", drag);
  svg.addEventListener("mouseup", endDrag);
}

function drag(e) {
  if (!dragItem) return;

  const CTM = svg.getScreenCTM();
  const mx = (e.clientX - CTM.e) / CTM.a;
  const my = (e.clientY - CTM.f) / CTM.d;

  if (dragItem.tagName === "rect") {
    dragItem.setAttribute("x", mx - dragOffset.x);
    dragItem.setAttribute("y", my - dragOffset.y);
  } 
  else {
    dragItem.setAttribute("cx", mx - dragOffset.x);
    dragItem.setAttribute("cy", my - dragOffset.y);
  }
}

function endDrag() {
  dragItem = null;

  svg.removeEventListener("mousemove", drag);
  svg.removeEventListener("mouseup", endDrag);
}
/* ============================
       UNIVERSAL 3D EDITOR
============================ */
let activeItem = null;

function enable3DEdit(el) {
  el.addEventListener("click", () => {
    activeItem = el;
    el.classList.add("edit-3d");
    document.getElementById("editor3d").style.display = "block";

    // preload values
    if (el.tagName === "ellipse") {
      itemWidth.value = el.getAttribute("rx");
      itemHeight.value = el.getAttribute("ry");
    } else {
      itemWidth.value = el.getAttribute("width");
      itemHeight.value = el.getAttribute("height");
    }
    itemColor.value = "#67e8f9";
    itemRotate.value = 0;
  });
}

document.getElementById("close3D").onclick = () => {
  if (activeItem) activeItem.classList.remove("edit-3d");
  activeItem = null;
  editor3d.style.display = "none";
};

// width
itemWidth.addEventListener("input", e => {
  if (!activeItem) return;

  if (activeItem.tagName === "ellipse") {
    activeItem.setAttribute("rx", e.target.value);
  } else {
    activeItem.setAttribute("width", e.target.value);
  }
});

// height
itemHeight.addEventListener("input", e => {
  if (!activeItem) return;

  if (activeItem.tagName === "ellipse") {
    activeItem.setAttribute("ry", e.target.value);
  } else {
    activeItem.setAttribute("height", e.target.value);
  }
});

// rotation
itemRotate.addEventListener("input", e => {
  if (!activeItem) return;

  activeItem.style.transform = `rotate(${e.target.value}deg)`;
});

// color
itemColor.addEventListener("input", e => {
  if (!activeItem) return;

  activeItem.setAttribute("fill", e.target.value + "55");
});
function drawFurniture(x, y, delay) {
  const g = elem("g", {}, "fall");
  add(g);
  setTimeout(() => g.classList.add("fall"), delay);

  const table = elem("rect", {
    x, y, width: 80, height: 50,
    fill: fillSoft, stroke
  });

  g.appendChild(table);

  table.classList.add("main-object");
  enableDrag(table);
  enable3DEdit(table);

  g.appendChild(textAt("FURNITURE", x, y - 8));
}
function drawBuffet(x, y, delay) {
  const g = elem("g", {}, "fall");
  add(g);
  setTimeout(() => g.classList.add("fall"), delay);

  const base = elem("rect", {
    x, y, width: 160, height: 50,
    fill: fillSoft, stroke
  });

  g.appendChild(base);

  base.classList.add("main-object");
  enableDrag(base);
  enable3DEdit(base);

  g.appendChild(textAt("BUFFET", x + 20, y - 8));
}
function drawRaisedBeds(x, y, w, h, delay) {
  const g = elem("g", {}, "fall");
  add(g);
  setTimeout(() => g.classList.add("fall"), delay);

  const bed = elem("rect", {
    x, y, width: w, height: h,
    fill: "rgba(103,232,249,0.1)",
    stroke
  });

  g.appendChild(bed);

  bed.classList.add("main-object");
  enableDrag(bed);
  enable3DEdit(bed);

  g.appendChild(textAt("RAISED BEDS", x + 6, y + h / 2));
}
setTimeout(() => {
  svg.querySelectorAll("rect, ellipse, circle").forEach(el => {
    if (!el.classList.contains("main-object")) return;
    enableDrag(el);
    enable3DEdit(el);
  });
}, 250);
