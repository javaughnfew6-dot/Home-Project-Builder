
# app.py
import os
import io
import json
import base64
from typing import Dict, Any, List, Optional

from fastapi import FastAPI, UploadFile, File, Form, Request
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel, Field, ValidationError
from PIL import Image
# OpenAI SDK v1
from openai import OpenAI

###############################################################################
# Models (Pydantic)
###############################################################################

class Preferences(BaseModel):
    budget: Optional[str] = Field(None, description="Low/Medium/High or $ range")
    skill_level: Optional[str] = Field(None, description="Beginner/Intermediate/Advanced")
    wood_preference: Optional[List[str]] = Field(None, description="['ipe','teak','cumaru','mahogany']")
    style: Optional[str] = Field(None, description="modern, rustic, traditional, japanese, etc.")

class Project(BaseModel):
    name: str
    why_it_fits: str
    estimated_cost_range: str
    difficulty: str
    estimated_time: str
    materials: List[str]
    tools: List[str]
    steps: List[str]
    placement_hint: Optional[str] = None
    maintenance_notes: Optional[str] = None

class AnalysisResult(BaseModel):
    description: str
    detected_features: List[str]
    sunlight_notes: Optional[str] = None
    yard_constraints: Optional[List[str]] = None
    suggested_projects: List[Project]

class ChatRequest(BaseModel):
    message: str
    history: Optional[List[Dict[str, str]]] = None  # [{role:'user'|'assistant', content:'...'}]
    context: Optional[Dict[str, Any]] = None        # carry over last analysis result


###############################################################################
# Prompts
###############################################################################

SYSTEM_ANALYST = """You are a friendly, practical DIY planner for backyard hardwood projects.
You analyze a single backyard photo and the user's preferences to recommend projects that fit
space, sun/shade, privacy needs, and skill/budget. You MUST produce strict JSON only.

Safety: Do not give cutting/structural advice that could cause harm. Encourage permits/code checks.
Measurements are approximate; advise verification with tape and local codes.

Hardwood focus: ipe, teak, cumaru, garapa, mahogany. If budget is low, suggest lower-cost alternatives
(like pressure-treated or composite) only as optional notes."""

ANALYSIS_JSON_SCHEMA = """
{
  "description": "1-3 sentences describing the backyard and layout.",
  "detected_features": ["list known elements like lawn, trees, patio, slope, fence"],
  "sunlight_notes": "approximate notes about shade vs sun areas if visible",
  "yard_constraints": ["drainage/slope/clearances/door swings if inferred"],
  "suggested_projects": [
    {
      "name": "Pergola / Deck / Fence / Raised Beds / Bench / Walkway / Storage Box / etc.",
      "why_it_fits": "Why it suits the pictured space.",
      "estimated_cost_range": "$$$ rough range appropriate to hardwood choice",
      "difficulty": "Beginner/Intermediate/Advanced",
      "estimated_time": "e.g., 1 weekend, 2–3 weekends",
      "materials": ["board feet, species hints, hardware, concrete if needed"],
      "tools": ["miter saw, drill/driver, post hole digger, PPE"],
      "steps": ["High-level, safe and sane steps only."],
      "placement_hint": "Where in the yard it likely fits best.",
      "maintenance_notes": "oil/sealant schedule, ventilation, end-grain sealing"
    }
  ]
}
"""

CHAT_SYSTEM = """You are a talkative, encouraging DIY assistant that helps refine backyard hardwood projects.
Use the prior analysis as context when available. Keep advice practical and safe, remind about permits/codes
for structural work, and provide material takeoffs only as rough estimates."""


###############################################################################
# Vision + LLM helpers (OpenAI or Azure OpenAI)
###############################################################################

USE_AZURE = bool(os.getenv("AZURE_OPENAI_ENDPOINT"))
MODEL_NAME = os.getenv("AZURE_OPENAI_DEPLOYMENT", "gpt-4o-mini")

def _client():
    # Single client used for both analyze + chat
    return OpenAI(
        api_key=os.getenv("OPENAI_API_KEY")
        if not USE_AZURE else os.getenv("AZURE_OPENAI_API_KEY")
    )

def _image_data_url(img_bytes: bytes, content_type: str = "image/jpeg") -> str:
    b64 = base64.b64encode(img_bytes).decode("utf-8")
    return f"data:{content_type};base64,{b64}"

def analyze_image_with_llm(img_bytes: bytes, preferences: Dict[str, Any], content_type: str) -> Dict[str, Any]:
    """
    Sends the image + preferences to a multimodal model and requests strict JSON output.
    Uses Chat Completions with image content (data URL).
    """
    client = _client()
    img_url = _image_data_url(img_bytes, content_type=content_type)

    user_content = [
        {"type": "text", "text": "Analyze this backyard photo for hardwood project ideas."},
        {"type": "input_image", "image_url": {"url": img_url}},
        {"type": "text", "text": f"Preferences: {json.dumps(preferences)}"},
        {"type": "text", "text": "Return ONLY JSON in the following schema:"},
        {"type": "text", "text": ANALYSIS_JSON_SCHEMA},
    ]

    # response_format enforces valid JSON
    resp = client.chat.completions.create(
        model=MODEL_NAME,
        messages=[
            {"role": "system", "content": SYSTEM_ANALYST},
            {"role": "user", "content": user_content}
        ],
        temperature=0.5,
        response_format={"type": "json_object"},
    )

    content = resp.choices[0].message.content
    try:
        return json.loads(content)
    except Exception as e:
        # Try crude JSON extraction if the model ever slips
        start = content.find("{")
        end = content.rfind("}")
        if start != -1 and end != -1:
            return json.loads(content[start:end+1])
        raise RuntimeError(f"LLM parsing error: {e}")

def heuristic_suggestions() -> Dict[str, Any]:
    """
    Very basic fallback if the vision model is unavailable (no API key, rate limit, etc.).
    """
    return {
        "description": "Backyard (generic). Exact layout unknown due to fallback mode.",
        "detected_features": ["unknown"],
        "sunlight_notes": "Unknown; consider where mid-day shade occurs.",
        "yard_constraints": ["Verify property lines and underground utilities (call 811)."],
        "suggested_projects": [
            {
                "name": "Ipe Deck (small platform)",
                "why_it_fits": "Works for most backdoors/patios to create a level seating area.",
                "estimated_cost_range": "$1,200–$3,000+ depending on size and species",
                "difficulty": "Intermediate",
                "estimated_time": "2 weekends",
                "materials": [
                    "Ipe decking boards 1x6",
                    "Joists + hangers",
                    "Stainless screws",
                    "Concrete deck blocks or footings",
                    "End-grain sealer",
                    "Exterior oil"
                ],
                "tools": ["Miter saw", "Drill/driver", "Joist square", "PPE"],
                "steps": [
                    "Plan size and check local codes; obtain permits if required.",
                    "Layout and set deck blocks or pour footings.",
                    "Build frame, ensure pitch and ventilation gaps.",
                    "Install decking with proper spacing; seal end-grain.",
                    "Oil top surface if desired; add trim."
                ],
                "placement_hint": "Adjacent to house/patio door.",
                "maintenance_notes": "Clean yearly; oil every 6–12 months if you want to preserve color."
            },
            {
                "name": "Cedar Privacy Screen",
                "why_it_fits": "Creates a cozy corner and blocks views without enclosing the whole yard.",
                "estimated_cost_range": "$250–$700",
                "difficulty": "Beginner",
                "estimated_time": "1 weekend",
                "materials": [
                    "Cedar boards 1x4/1x6",
                    "Posts 4x4 (pressure-treated base optional)",
                    "Exterior screws",
                    "Concrete for post footings"
                ],
                "tools": ["Drill/driver", "Post-hole digger", "Level", "Saw", "PPE"],
                "steps": [
                    "Mark layout; call 811 before digging.",
                    "Set posts in concrete below frost line (check local depth).",
                    "Attach horizontal or slatted boards with even spacing.",
                    "Seal/stain as desired."
                ],
                "placement_hint": "Line of sight you want to block.",
                "maintenance_notes": "Re-seal/stain every 1–2 years."
            }
        ]
    }


###############################################################################
# FastAPI App
###############################################################################

app = FastAPI(title="Backyard Hardwood AI (Single-File)")

# Not strictly needed (same-origin), but handy if you host frontend elsewhere later
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # tighten in production
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.get("/", response_class=HTMLResponse)
async def index(_: Request):
    """
    Serves the entire Frontend (HTML+CSS+JS) from a single string.
    """
    html = """
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Backyard Hardwood AI</title>
  <style>
    :root { color-scheme: light dark; --bg:#fff; --fg:#111; --muted:#666; --card:#fff; --border:#ddd; --accent:#0f62fe;}
    html,body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 6px; }
    .muted { color: var(--muted); margin: 0 0 16px; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 12px; }
    .card { border: 1px solid var(--border); border-radius: 10px; padding: 16px; background: var(--card); }
    .preview { max-width: 100%; margin-top: 8px; border-radius: 8px; }
    .row { display: flex; align-items: center; gap: 12px; margin: 12px 0; }
    .error { color: #b00020; }
    button { padding: 10px 14px; border-radius: 8px; border: 0; background: var(--accent); color: white; cursor: pointer; }
    button:disabled { background: #9bbcff; cursor: wait; }
    label { display: block; margin: 8px 0; }
    fieldset { border: 1px solid var(--border); padding: 8px; border-radius: 8px; }
    .chip { margin-right: 8px; }
    .chat { min-height: 120px; border: 1px solid #eee; border-radius: 8px; padding: 8px; background: #fafafa; margin: 8px 0; max-height: 280px; overflow: auto; }
    .bubble { max-width: 80%; margin: 6px 0; padding: 8px 10px; border-radius: 12px; }
    .bubble.user { background: #e8f0fe; margin-left:auto; }
    .bubble.assistant { background: #f1f3f4; margin-right:auto; }
    .spinner { padding: 6px 10px; background:#f1f3f4; border-radius: 8px; }
    .project h5 { margin: 8px 0 4px; }
    .vis { font-size: 12px; color: var(--muted); margin-top: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Backyard Hardwood AI</h1>
    <p class="muted">
      Upload your backyard photo to get hardwood project ideas (decks, pergolas, fences, raised beds, walkways, benches), then chat with the planner.<br/>
      <strong>Note:</strong> Measurements/estimates are approximate. Check local codes/permits and call 811 before digging.
    </p>

    <div class="grid2">
      <div class="card">
        <h3>1) Upload your backyard photo</h3>
        <input id="file" type="file" accept="image/*"/>
        <img id="preview" class="preview" style="display:none"/>
        <div id="fileInfo" class="vis"></div>
      </div>

      <div class="card">
        <h3>2) Preferences</h3>
        <label>Budget
          <select id="prefBudget">
            <option value="">—</option>
            <option>Low</option><option>Medium</option><option>High</option>
          </select>
        </label>

        <label>Skill Level
          <select id="prefSkill">
            <option value="">—</option>
            <option>Beginner</option><option>Intermediate</option><option>Advanced</option>
          </select>
        </label>

        <label>Style
          <input id="prefStyle" placeholder="modern / rustic / traditional"/>
        </label>

        <fieldset>
          <legend>Hardwood Preference</legend>
          <label class="chip"><input type="checkbox" class="wood" value="ipe" checked/> ipe</label>
          <label class="chip"><input type="checkbox" class="wood" value="teak"/> teak</label>
          <label class="chip"><input type="checkbox" class="wood" value="cumaru"/> cumaru</label>
          <label class="chip"><input type="checkbox" class="wood" value="garapa"/> garapa</label>
          <label class="chip"><input type="checkbox" class="wood" value="mahogany"/> mahogany</label>
        </fieldset>
      </div>
    </div>

    <div class="row">
      <button id="analyzeBtn">Analyze Photo</button>
      <div id="spinner" class="spinner" style="display:none">Analyzing…</div>
      <div id="error" class="error"></div>
    </div>

    <div id="results" class="card" style="display:none">
      <h3>Results</h3>
      <p><strong>Description:</strong> <span id="desc"></span></p>
      <p id="sunRow" style="display:none"><strong>Sunlight:</strong> <span id="sun"></span></p>
      <p id="detRow" style="display:none"><strong>Detected:</strong> <span id="det"></span></p>
      <p id="conRow" style="display:none"><strong>Constraints:</strong> <span id="con"></span></p>

      <h4>Suggested Projects</h4>
      <div id="projGrid" class="grid"></div>
    </div>

    <div class="card">
      <h3>Ask the DIY Assistant</h3>
      <div id="chatBox" class="chat"></div>
      <div class="row">
        <input id="chatInput" placeholder="e.g., Can I add a pergola to the left corner?"/>
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id)
    const state = {
      file: null,
      analysis: null,
      history: []
    }

    // Image preview
    $('file').addEventListener('change', (e) => {
      const f = e.target.files?.[0]
      if (!f) return
      state.file = f
      const url = URL.createObjectURL(f)
      const img = $('preview')
      img.src = url
      img.style.display = 'block'
      $('fileInfo').textContent = f.name + ' • ' + Math.round(f.size/1024) + ' KB'
    })

    // Gather preferences
    function collectPrefs() {
      const woods = [...document.querySelectorAll('.wood:checked')].map(el => el.value)
      return {
        budget: $('prefBudget').value || null,
        skill_level: $('prefSkill').value || null,
        style: $('prefStyle').value || null,
        wood_preference: woods.length ? woods : null
      }
    }

    // Render projects
    function renderProjects(list) {
      const grid = $('projGrid')
      grid.innerHTML = ''
      ;(list || []).forEach((p, i) => {
        const div = document.createElement('div')
        div.className = 'project card'
        div.innerHTML = `
          <h5>${p.name || ''}</h5>
          <p>${p.why_it_fits || ''}</p>
          <p><strong>Cost:</strong> ${p.estimated_cost_range || ''}</p>
          <p><strong>Difficulty:</strong> ${p.difficulty || ''}</p>
          <p><strong>Time:</strong> ${p.estimated_time || ''}</p>
          ${p.placement_hint ? `<p><strong>Placement:</strong> ${p.placement_hint}</p>` : ''}
          ${p.maintenance_notes ? `<p><strong>Maintenance:</strong> ${p.maintenance_notes}</p>` : ''}
          <details><summary>Materials</summary>
            <ul>${(p.materials||[]).map(m=>`<li>${m}</li>`).join('')}</ul>
          </details>
          <details><summary>Tools</summary>
            <ul>${(p.tools||[]).map(t=>`<li>${t}</li>`).join('')}</ul>
          </details>
          <details><summary>Steps</summary>
            <ol>${(p.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol>
          </details>
        `
        grid.appendChild(div)
      })
    }

    // Analyze click
    $('analyzeBtn').addEventListener('click', async () => {
      $('error').textContent = ''
      if (!state.file) { $('error').textContent = 'Please upload an image first.'; return }
      $('spinner').style.display = 'inline-block'

      const form = new FormData()
      form.append('image', state.file)
      form.append('preferences', JSON.stringify(collectPrefs()))

      try {
        const res = await fetch('/api/analyze', { method:'POST', body: form })
        const data = await res.json()
        $('spinner').style.display = 'none'
        if (!data.ok) { $('error').textContent = data.error || 'Something went wrong.'; return }
        state.analysis = data.analysis

        $('results').style.display = 'block'
        $('desc').textContent = state.analysis.description || ''
        if (state.analysis.sunlight_notes) { $('sun').textContent = state.analysis.sunlight_notes; $('sunRow').style.display='block' } else { $('sunRow').style.display='none' }
